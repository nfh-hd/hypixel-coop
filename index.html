<script>
    const ziel = 8000000000;
    let werte = {
        nico: 0,
        niklas: 0
    };
    const ADMIN_PASSWORT = "SBCS666";
    let istAdmin = false;

    // GitHub API Konfiguration
    const GITHUB_USERNAME = "nfh-hd";
    const GITHUB_REPO = "hypixel-coop";
    const GITHUB_FILE_PATH = "coins.txt";
    const GITHUB_TOKEN = "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";

    const GITHUB_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`;

    function formatNumber(n) {
        return n.toLocaleString('de-DE');
    }

    async function update(name, add) {
        if (!istAdmin) return;
        const input = document.getElementById(name + "-input");
        let val = Number(input.value);
        if (isNaN(val) || val <= 0) return;

        await loadFromGitHub();

        if (add) {
            werte[name] += val;
        } else {
            werte[name] -= val;
            if (werte[name] < 0) werte[name] = 0;
        }

        render();
        input.value = "";
        await saveToGitHub();
    }

    function render() {
        ["nico", "niklas"].forEach(name => {
            document.getElementById(name + "-value").textContent = formatNumber(werte[name]);
            let remaining = ziel - werte[name];
            if (remaining < 0) remaining = 0;
            document.getElementById(name + "-remaining").textContent =
                "Verbleibend: " + formatNumber(remaining);
        });

        if (istAdmin) {
            document.getElementById("nico-controls").classList.remove("hidden");
            document.getElementById("niklas-controls").classList.remove("hidden");
        } else {
            document.getElementById("nico-controls").classList.add("hidden");
            document.getElementById("niklas-controls").classList.add("hidden");
        }
    }

    async function saveToGitHub() {
        try {
            const response = await fetch(GITHUB_API_URL, {
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`
                }
            });
            if (!response.ok) {
                if (response.status === 404) {
                    console.error("Datei nicht gefunden. Stelle sicher, dass der Pfad korrekt ist.");
                    return;
                }
                throw new Error(`GitHub API Fehler (SHA-Abruf): ${response.statusText}`);
            }
            const data = await response.json();
            const sha = data.sha;

            const newContent = btoa(JSON.stringify(werte));

            const updateResponse = await fetch(GITHUB_API_URL, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: 'Update coin values',
                    content: newContent,
                    sha: sha
                })
            });

            if (!updateResponse.ok) {
                throw new Error(`GitHub API Fehler (Speichern): ${updateResponse.statusText}`);
            }
            console.log("Daten erfolgreich auf GitHub gespeichert.");
        } catch (error) {
            console.error("Fehler beim Speichern auf GitHub:", error);
        }
    }

    async function loadFromGitHub() {
        try {
            const response = await fetch(GITHUB_API_URL, {
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`
                }
            });
            if (response.ok) {
                const data = await response.json();
                const content = atob(data.content);
                werte = JSON.parse(content);
            } else {
                console.warn("Datei existiert nicht oder kann nicht geladen werden. Starte mit Standardwerten.");
            }
            render();
        } catch (error) {
            console.error("Fehler beim Laden von GitHub:", error);
            render();
        }
    }

    function login() {
        const pw = document.getElementById("password").value;
        if (pw === ADMIN_PASSWORT) {
            istAdmin = true;
            document.getElementById("feedback").textContent = "Erfolgreich als Admin eingeloggt!";
            document.getElementById("feedback").style.color = "#00ff99";
        } else {
            istAdmin = false;
            document.getElementById("feedback").textContent = "Falsches Passwort!";
            document.getElementById("feedback").style.color = "#ff6666";
        }
        render();
    }

    function logout() {
        istAdmin = false;
        document.getElementById("feedback").textContent = "Als Gast eingeloggt";
        document.getElementById("feedback").style.color = "#ffecb3";
        render();
    }

    loadFromGitHub();
</script>
